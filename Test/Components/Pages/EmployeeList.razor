@page "/"
@using TestModels;
@using Test.Services;
@inject IEmployeeServices EmpServices;
@using System.Data.SqlClient


<h1>Employee List</h1>
<MudPaper>
	<MudTable Items="@empList" Hover="true" Breakpoint="Breakpoint.Sm">
		<ToolBarContent>
			<MudGrid Justify="Justify.FlexEnd">
				<MudItem Style="margin-right: 10px">
					<MudIcon Icon="@Icons.Material.Filled.Search" />
				</MudItem>
				<input T="int" @oninput="Search" style="border-style:solid; border-width:2px; margin-top: 18px"/>
			</MudGrid>
		</ToolBarContent>
		<HeaderContent>
			<MudTh>EID</MudTh>
			<MudTh>Name</MudTh>
			<MudTh>Dob</MudTh>
			<MudTh>Title</MudTh>
			<MudTh>Task</MudTh>
			<MudTh>Action</MudTh>
		</HeaderContent>
		<RowTemplate>
			<MudTd DataLabel="EID">@context.EID</MudTd>
			<MudTd DataLabel="Name">@context.Name</MudTd>
			<MudTd DataLabel="Dob">@context.Dob</MudTd>
			<MudTd DataLabel="Title">@context.Title</MudTd>
			<MudTd DataLabel="Task">@context.Task</MudTd>
			<MudTd DataLabel="Action" Style="align-items:center"><MudButton Color="Color.Primary" OnClick="@(()=>OpenDialogAsync(context.EID))">Update</MudButton>|<MudButton Color="Color.Error" OnClick="@(()=>DeleteEmployee(context.EID))">Delete</MudButton></MudTd>
		</RowTemplate>
	</MudTable>

	<MudDialog>
		<TitleContent>

		</TitleContent>
	</MudDialog>

	<MudDialog @bind-Visible="_updateVisible" Options="op">
		<TitleContent>
			<MudText Typo="Typo.h6">Update Employee</MudText>
		</TitleContent>
		<DialogContent>
			<EditForm Model="@newEmp">
				<MudItem>
					<MudTextField Label="EID" @bind-Value="@newEmp.EID" ReadOnly/>
					<MudTextField Label="Name" @bind-Value="@newEmp.Name" />
					<MudTextField Label="Dob" @bind-Value="@newEmp.Dob" />
					<MudTextField Label="Title" @bind-Value="@newEmp.Title" />
					<MudTextField Label="Task" @bind-Value="@newEmp.Task" />
				</MudItem>
			</EditForm>
		</DialogContent>
		<DialogActions>
			<MudButton ButtonType="ButtonType.Submit" OnClick="()=>UpdateEmployee(newEmp)">Submit</MudButton>
		</DialogActions>
	</MudDialog>
</MudPaper>




@code{
	public bool _updateVisible = false;
	private List<TestModels.Employee> empList = new List<TestModels.Employee>(1000);
	private List<TestModels.Employee> temp = new List<TestModels.Employee>(1000);
	public TestModels.Employee newEmp = new TestModels.Employee();
	DialogOptions op = new DialogOptions
	{
		CloseOnEscapeKey = true,
		FullWidth = true,
		CloseButton = true,
		BackdropClick = true,
		Position = DialogPosition.Center,
		MaxWidth = MaxWidth.ExtraSmall
	};

	protected override async Task OnInitializedAsync()
	{
		await GetEmployee();
	}

	private async Task GetEmployee()
	{
		empList.Clear();
		empList = await EmpServices.GetEmployee();
		StateHasChanged();

	}

	public async Task UpdateEmployee(Employee emp)
	{
		await EmpServices.UpdateEmployee(emp);
		_updateVisible = false;
		await GetEmployee();
		StateHasChanged();
	}

	public async Task DeleteEmployee(int id)
	{
		await EmpServices.DelEmployee(id);
		await GetEmployee();
	}

	public async Task GetByID(int id)
	{
		empList.Clear();
		empList = await EmpServices.GetEmployeeByID(id);
		StateHasChanged();
	}

	public async Task Search(Microsoft.AspNetCore.Components.ChangeEventArgs args)
	{
		if (args.Value == "")
		{
			await GetEmployee();
		}
		else
		{
			var searchTerm = (string)args.Value;
			await GetByID(int.Parse(searchTerm));
			StateHasChanged();
		}
	}

	private async Task OpenDialogAsync(int id)
	{
		temp.Clear();
		temp = await EmpServices.GetEmployeeByID(id);
		newEmp = temp[0];
		_updateVisible = true;
		StateHasChanged();
	}
}
